<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç± Admin - Qu·∫£n L√Ω ƒê·∫∑t C∆°m</title>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800&display=swap');

        :root {
            --bg: #f5f0eb;
            --card: #fff;
            --primary: #e07a2f;
            --primary-light: #fdf0e4;
            --primary-dark: #c46820;
            --text: #2d2a26;
            --dim: #8c857c;
            --border: #e8e2db;
            --success: #3a9d5c;
            --success-light: #e8f5ec;
            --danger: #d64040;
            --danger-light: #fff3f3;
            --blue: #3b82f6;
            --blue-light: #eff6ff;
            --radius: 14px;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh
        }

        /* Login */
        .login-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-overlay.hidden {
            display: none
        }

        .login-card {
            max-width: 380px;
            width: 100%;
            background: var(--card);
            border-radius: 20px;
            padding: 36px 28px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.08);
            text-align: center;
            border: 1px solid var(--border);
        }

        .login-card .icon {
            font-size: 2.8rem;
            margin-bottom: 12px
        }

        .login-card h2 {
            font-size: 1.3rem;
            margin-bottom: 4px;
            color: var(--primary)
        }

        .login-card .sub {
            color: var(--dim);
            font-size: 0.85rem;
            margin-bottom: 24px
        }

        .login-card input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-family: 'Be Vietnam Pro', sans-serif;
            font-size: 1rem;
            outline: none;
            margin-bottom: 14px;
            transition: border-color 0.2s;
        }

        .login-card input:focus {
            border-color: var(--primary)
        }

        .login-err {
            color: var(--danger);
            font-size: 0.85rem;
            margin-bottom: 10px;
            display: none
        }

        /* Header */
        .top-bar {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .top-bar h1 {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .top-bar .date {
            font-size: 0.82rem;
            color: var(--dim);
            font-weight: 500
        }

        .app {
            max-width: 960px;
            margin: 0 auto;
            padding: 16px
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--card);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 0;
            padding: 10px 8px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--dim);
            font-family: 'Be Vietnam Pro', sans-serif;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 2px 8px rgba(224, 122, 47, 0.3)
        }

        .tab:hover:not(.active) {
            background: var(--primary-light);
            color: var(--primary)
        }

        .panel {
            display: none;
            animation: fadeUp 0.3s ease
        }

        .panel.active {
            display: block
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(8px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .card-sub {
            font-size: 0.78rem;
            color: var(--dim)
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-family: 'Be Vietnam Pro', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff
        }

        .btn-primary:hover {
            background: var(--primary-dark)
        }

        .btn-success {
            background: var(--success);
            color: #fff
        }

        .btn-danger {
            background: var(--danger);
            color: #fff
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text)
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary)
        }

        .btn-blue {
            background: var(--blue);
            color: #fff
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.78rem;
            border-radius: 8px
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed
        }

        .btn-full {
            width: 100%
        }

        /* Forms */
        .form-row {
            margin-bottom: 12px
        }

        .form-row label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dim);
            margin-bottom: 4px
        }

        .form-row input,
        .form-row select,
        .form-row textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-family: 'Be Vietnam Pro', sans-serif;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
            background: #fff;
            color: var(--text);
        }

        .form-row input:focus,
        .form-row select:focus,
        .form-row textarea:focus {
            border-color: var(--primary)
        }

        .form-row textarea {
            resize: vertical;
            min-height: 80px
        }

        .form-inline {
            display: flex;
            gap: 8px;
            align-items: end
        }

        .form-inline .form-row {
            flex: 1;
            margin-bottom: 0
        }

        /* Tables */
        .tbl-wrap {
            overflow-x: auto;
            margin: 0 -20px;
            padding: 0 20px
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem
        }

        th {
            text-align: left;
            padding: 10px 12px;
            background: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 700;
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle
        }

        tr:hover td {
            background: #faf8f5
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 700;
        }

        .badge-active {
            background: var(--success-light);
            color: var(--success)
        }

        .badge-inactive {
            background: var(--danger-light);
            color: var(--danger)
        }

        .badge-picked {
            background: var(--success-light);
            color: var(--success)
        }

        .badge-waiting {
            background: #fffbe6;
            color: #b8860b
        }

        /* Stats */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin-bottom: 16px
        }

        .stat-card {
            text-align: center;
            padding: 16px 12px;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .stat-card .num {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--primary)
        }

        .stat-card .label {
            font-size: 0.75rem;
            color: var(--dim);
            font-weight: 600;
            margin-top: 2px
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.hidden {
            display: none
        }

        .modal {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            max-width: 440px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
        }

        .modal h3 {
            font-size: 1.05rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        /* Filter bar */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-bar .form-row {
            margin-bottom: 0;
            min-width: 140px
        }

        .empty {
            text-align: center;
            padding: 30px;
            color: var(--dim)
        }

        .empty .icon {
            font-size: 2rem;
            margin-bottom: 8px
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .mb-8 {
            margin-bottom: 8px
        }

        .mb-16 {
            margin-bottom: 16px
        }

        .mt-12 {
            margin-top: 12px
        }

        .gap-8 {
            gap: 8px;
            display: flex
        }

        /* Pickup toggle */
        .pickup-btn {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: 'Be Vietnam Pro', sans-serif;
            transition: all 0.2s;
        }

        .pickup-btn.not-picked {
            background: #fffbe6;
            color: #b8860b
        }

        .pickup-btn.picked {
            background: var(--success-light);
            color: var(--success)
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.85rem;
            color: var(--success);
            font-weight: 600;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.5s forwards;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px)
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0)
            }
        }

        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(20px)
            }
        }

        @media(max-width:600px) {
            .tab {
                font-size: 0.7rem;
                padding: 8px 4px
            }

            .card {
                padding: 16px
            }

            .stat-grid {
                grid-template-columns: repeat(2, 1fr)
            }

            .filter-bar {
                flex-direction: column
            }

            .filter-bar .form-row {
                min-width: 100%
            }

            .form-inline {
                flex-direction: column
            }
        }
    </style>
</head>

<body>

    <!-- LOGIN -->
    <div class="login-overlay" id="login-overlay">
        <div class="login-card">
            <div class="icon">üîê</div>
            <h2>ƒêƒÉng Nh·∫≠p Admin</h2>
            <p class="sub">Qu·∫£n l√Ω ƒë·∫∑t c∆°m tr∆∞a</p>
            <input type="password" id="pw-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..."
                onkeydown="if(event.key==='Enter')checkLogin()">
            <div class="login-err" id="login-err">‚ùå Sai m·∫≠t kh·∫©u!</div>
            <button class="btn btn-primary btn-full" onclick="checkLogin()">üöÄ ƒêƒÉng Nh·∫≠p</button>
            <p style="margin-top:14px;font-size:0.75rem;color:var(--dim)">Connect Admin Viettran to more information</p>
        </div>
    </div>

    <!-- TOP BAR -->
    <div class="top-bar" id="top-bar" style="display:none">
        <h1>üç± Qu·∫£n L√Ω ƒê·∫∑t C∆°m</h1>
        <div class="date" id="top-date"></div>
    </div>

    <div class="app" id="app" style="display:none">
        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('orders')">üìã ƒê∆°n h√¥m nay</button>
            <button class="tab" onclick="switchTab('menu')">üçΩÔ∏è Menu</button>
            <button class="tab" onclick="switchTab('staff')">üë• Nh√¢n s·ª±</button>
            <button class="tab" onclick="switchTab('stats')">üìä Th·ªëng k√™</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è C√†i ƒë·∫∑t</button>
        </div>

        <!-- ==================== ORDERS PANEL ==================== -->
        <div id="panel-orders" class="panel active">
            <!-- Date picker -->
            <div class="card" style="padding:14px 20px">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                    <span style="font-weight:700;font-size:0.9rem">üìÖ Xem ng√†y:</span>
                    <button class="btn btn-sm btn-outline" onclick="shiftViewDate(-1)">‚óÄ H√¥m tr∆∞·ªõc</button>
                    <input type="date" id="view-date" onchange="changeViewDate()"
                        style="padding:8px 12px;border:2px solid var(--border);border-radius:8px;font-family:'Be Vietnam Pro',sans-serif;font-size:0.85rem;font-weight:600;outline:none">
                    <button class="btn btn-sm btn-outline" onclick="shiftViewDate(1)">H√¥m sau ‚ñ∂</button>
                    <button class="btn btn-sm btn-primary" onclick="goToday()">H√¥m nay</button>
                    <span style="font-weight:600;color:var(--dim);font-size:0.85rem;margin-left:auto"
                        id="view-date-label"></span>
                </div>
            </div>

            <!-- Stats bar -->
            <div class="stat-grid" id="today-stats">
                <div class="stat-card">
                    <div class="num" id="s-total">0</div>
                    <div class="label">T·ªïng ƒë·∫∑t</div>
                </div>
                <div class="stat-card">
                    <div class="num" id="s-picked">0</div>
                    <div class="label">ƒê√£ l·∫•y</div>
                </div>
                <div class="stat-card">
                    <div class="num" id="s-waiting">0</div>
                    <div class="label">Ch∆∞a l·∫•y</div>
                </div>
                <div class="stat-card">
                    <div class="num" id="s-dishes">0</div>
                    <div class="label">S·ªë m√≥n</div>
                </div>
            </div>

            <!-- Dish breakdown -->
            <div class="card" id="dish-breakdown-card">
                <div class="card-head">
                    <div class="card-title">üçΩÔ∏è Th·ªëng k√™ theo t·ª´ng m√≥n</div>
                    <div class="card-sub" id="breakdown-total-label"></div>
                </div>
                <div id="dish-breakdown"></div>
            </div>

            <!-- Order list -->
            <div class="card">
                <div class="card-head">
                    <div class="card-title">üìã Danh s√°ch chi ti·∫øt</div>
                    <div class="gap-8">
                        <select id="filter-dish" onchange="renderOrders()"
                            style="padding:6px 10px;border:1px solid var(--border);border-radius:8px;font-family:'Be Vietnam Pro',sans-serif;font-size:0.78rem;outline:none">
                            <option value="">T·∫•t c·∫£ m√≥n</option>
                        </select>
                        <button class="btn btn-blue btn-sm" onclick="exportDayExcel()">üì• Excel</button>
                    </div>
                </div>
                <div class="tbl-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>M√£ NV</th>
                                <th>H·ªç t√™n</th>
                                <th>M√≥n ƒÉn</th>
                                <th>Gi·ªù ƒë·∫∑t</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody"></tbody>
                    </table>
                </div>
                <div class="empty" id="orders-empty">
                    <div class="icon">üìã</div>
                    <p>Ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t c∆°m</p>
                </div>
            </div>
        </div>

        <!-- ==================== MENU PANEL ==================== -->
        <div id="panel-menu" class="panel">
            <!-- Menu Date Picker -->
            <div class="card" style="padding:14px 20px">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                    <span style="font-weight:700;font-size:0.9rem">üìÖ Menu ng√†y:</span>
                    <button class="btn btn-sm btn-outline" onclick="shiftMenuDate(-1)">‚óÄ H√¥m tr∆∞·ªõc</button>
                    <input type="date" id="menu-date" onchange="changeMenuDate()"
                        style="padding:8px 12px;border:2px solid var(--border);border-radius:8px;font-family:'Be Vietnam Pro',sans-serif;font-size:0.85rem;font-weight:600;outline:none">
                    <button class="btn btn-sm btn-outline" onclick="shiftMenuDate(1)">H√¥m sau ‚ñ∂</button>
                    <button class="btn btn-sm btn-primary" onclick="goTodayMenu()">H√¥m nay</button>
                    <span style="font-weight:600;color:var(--dim);font-size:0.85rem;margin-left:auto"
                        id="menu-date-label"></span>
                </div>
            </div>

            <div class="card">
                <div class="card-head">
                    <div class="card-title">üçΩÔ∏è Menu ‚Äî <span id="menu-card-date-label"></span></div>
                </div>

                <div class="form-inline mb-16">
                    <div class="form-row">
                        <label>Th√™m m√≥n ƒÉn</label>
                        <input type="text" id="new-dish" placeholder="V√≠ d·ª•: C√° h∆∞·ªùng chi√™n s·∫£"
                            onkeydown="if(event.key==='Enter')addDish()">
                    </div>
                    <button class="btn btn-primary" onclick="addDish()" style="margin-top:auto">+ Th√™m</button>
                </div>

                <div id="menu-items-list"></div>

                <div class="empty" id="menu-empty">
                    <div class="icon">üçΩÔ∏è</div>
                    <p>Ch∆∞a c√≥ m√≥n n√†o</p>
                </div>

                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <div class="card-title mb-8">üìã Th√™m nhanh nhi·ªÅu m√≥n</div>
                <div class="form-row">
                    <textarea id="bulk-dishes"
                        placeholder="M·ªói d√≤ng 1 m√≥n, v√≠ d·ª•:&#10;C√° h∆∞·ªùng chi√™n s·∫£, Th·ªãt ba r·ªçi ch√°y c·∫°nh&#10;G√† n∆∞·ªõng mu·ªëi ·ªõt, Th·ªãt ram n∆∞·ªõc d·ª´a&#10;Th·ªãt ba r·ªçi ch√°y c·∫°nh, Canh chua c√° basa"></textarea>
                </div>
                <button class="btn btn-primary" onclick="bulkAddDishes()">+ Th√™m t·∫•t c·∫£</button>

                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <div class="card-title mb-8">üìÖ Copy menu t·ª´ ng√†y kh√°c</div>
                <div class="form-inline">
                    <div class="form-row">
                        <input type="date" id="copy-date">
                    </div>
                    <button class="btn btn-outline" onclick="copyMenuFrom()">üìã Copy menu</button>
                </div>
            </div>
        </div>

        <!-- ==================== STAFF PANEL ==================== -->
        <div id="panel-staff" class="panel">
            <div class="card">
                <div class="card-head">
                    <div class="card-title">üë• Danh s√°ch nh√¢n vi√™n</div>
                    <div class="gap-8">
                        <button class="btn btn-primary btn-sm" onclick="showAddStaffModal()">+ Th√™m NV</button>
                        <button class="btn btn-blue btn-sm" onclick="exportStaffExcel()">üì• Excel</button>
                    </div>
                </div>

                <div class="form-row mb-16">
                    <input type="text" id="staff-search" placeholder="üîç T√¨m theo m√£ ho·∫∑c t√™n..."
                        oninput="renderStaff()">
                </div>

                <div class="tbl-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>M√£ NV</th>
                                <th>H·ªç t√™n</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="staff-tbody"></tbody>
                    </table>
                </div>
                <div class="empty" id="staff-empty">
                    <div class="icon">üë•</div>
                    <p>Ch∆∞a c√≥ nh√¢n vi√™n</p>
                </div>

                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <div class="card-title mb-8">üìã Th√™m nhanh nhi·ªÅu nh√¢n vi√™n</div>
                <div class="form-row">
                    <textarea id="bulk-staff"
                        placeholder="M·ªói d√≤ng: M√£NV, H·ªç t√™n&#10;V√≠ d·ª•:&#10;NV001, Nguy·ªÖn VƒÉn A&#10;NV002, Tr·∫ßn Th·ªã B&#10;NV003, L√™ VƒÉn C"></textarea>
                </div>
                <button class="btn btn-primary" onclick="bulkAddStaff()">+ Th√™m t·∫•t c·∫£</button>
            </div>
        </div>

        <!-- ==================== STATS PANEL ==================== -->
        <div id="panel-stats" class="panel">
            <div class="card">
                <div class="card-head">
                    <div class="card-title">üìä Th·ªëng k√™ ƒë·∫∑t c∆°m</div>
                    <button class="btn btn-blue btn-sm" onclick="exportStatsExcel()">üì• Xu·∫•t Excel</button>
                </div>

                <div class="filter-bar">
                    <div class="form-row">
                        <label>Xem theo</label>
                        <select id="stats-mode" onchange="loadStats()">
                            <option value="day">Theo ng√†y</option>
                            <option value="week">Theo tu·∫ßn</option>
                            <option value="month">Theo th√°ng</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label>T·ª´ ng√†y</label>
                        <input type="date" id="stats-from" onchange="loadStats()">
                    </div>
                    <div class="form-row">
                        <label>ƒê·∫øn ng√†y</label>
                        <input type="date" id="stats-to" onchange="loadStats()">
                    </div>
                </div>

                <div class="stat-grid" id="stats-summary"></div>

                <div class="tbl-wrap">
                    <table>
                        <thead id="stats-thead"></thead>
                        <tbody id="stats-tbody"></tbody>
                    </table>
                </div>
                <div class="empty" id="stats-empty">
                    <div class="icon">üìä</div>
                    <p>Ch·ªçn kho·∫£ng th·ªùi gian ƒë·ªÉ xem th·ªëng k√™</p>
                </div>
            </div>
        </div>

        <!-- ==================== SETTINGS PANEL ==================== -->
        <div id="panel-settings" class="panel">
            <div class="card">
                <div class="card-title mb-16">‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</div>

                <div class="form-row">
                    <label>Gi·ªù ch·ªët ƒë·∫∑t c∆°m m·ªói ng√†y</label>
                    <input type="time" id="set-deadline" value="10:00">
                </div>
                <button class="btn btn-primary mt-12" onclick="saveSettings()">üíæ L∆∞u c√†i ƒë·∫∑t</button>
            </div>

            <div class="card">
                <div class="card-title mb-16">üîë ƒê·ªïi m·∫≠t kh·∫©u Admin</div>
                <div class="form-row">
                    <label>M·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="new-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi...">
                </div>
                <div class="form-row">
                    <label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="confirm-password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u...">
                </div>
                <button class="btn btn-primary mt-12" onclick="changePassword()">üîë ƒê·ªïi m·∫≠t kh·∫©u</button>
            </div>

            <div class="card">
                <div class="card-title mb-16" style="color:var(--danger)">‚ö†Ô∏è V√πng nguy hi·ªÉm</div>
                <button class="btn btn-danger" onclick="clearTodayOrders()">üóëÔ∏è Xo√° t·∫•t c·∫£ ƒë∆°n h√¥m nay</button>
            </div>
        </div>
    </div>

    <!-- STAFF MODAL -->
    <div class="modal-overlay hidden" id="staff-modal">
        <div class="modal">
            <h3 id="modal-title">‚ûï Th√™m nh√¢n vi√™n</h3>
            <div class="form-row">
                <label>M√£ nh√¢n vi√™n</label>
                <input type="text" id="m-code" placeholder="VD: NV001">
            </div>
            <div class="form-row">
                <label>H·ªç v√† t√™n</label>
                <input type="text" id="m-name" placeholder="VD: Nguy·ªÖn VƒÉn A">
            </div>
            <div class="form-row">
                <label>Tr·∫°ng th√°i</label>
                <select id="m-active">
                    <option value="true">ƒêang l√†m vi·ªác</option>
                    <option value="false">ƒê√£ ngh·ªâ vi·ªác</option>
                </select>
            </div>
            <div style="display:flex;gap:8px;margin-top:16px">
                <button class="btn btn-outline" onclick="closeStaffModal()" style="flex:1">Hu·ª∑</button>
                <button class="btn btn-primary" onclick="saveStaff()" style="flex:1" id="modal-save-btn">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- PICKUP MODAL -->
    <div class="modal-overlay hidden" id="pickup-modal">
        <div class="modal">
            <h3>üç± X√°c nh·∫≠n l·∫•y c∆°m</h3>
            <p style="color:var(--dim);margin-bottom:16px;font-size:0.9rem" id="pickup-info"></p>
            <div class="form-row">
                <label>Ai l·∫•y?</label>
                <select id="pickup-who">
                    <option value="self">T·ª± l·∫•y</option>
                    <option value="other">Ng∆∞·ªùi kh√°c l·∫•y h·ªô</option>
                </select>
            </div>
            <div class="form-row" id="pickup-other-group" style="display:none">
                <label>T√™n ng∆∞·ªùi l·∫•y h·ªô</label>
                <input type="text" id="pickup-other-name" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi l·∫•y h·ªô...">
            </div>
            <div style="display:flex;gap:8px;margin-top:16px">
                <button class="btn btn-outline" onclick="closePickupModal()" style="flex:1">Hu·ª∑</button>
                <button class="btn btn-success" onclick="confirmPickup()" style="flex:1">‚úÖ X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        // ‚ïë  ‚ö†Ô∏è  THAY TH√îNG TIN FIREBASE V√ÄO ƒê√ÇY                     ‚ïë
        // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        const firebaseConfig = {
            apiKey: "AIzaSyCOE5tHOCnxt8OJ7pqrQkJDbv8omtjz7WU",
            authDomain: "book-com-trua.firebaseapp.com",
            projectId: "book-com-trua",
            storageBucket: "book-com-trua.firebasestorage.app",
            messagingSenderId: "274863804638",
            appId: "1:274863804638:web:66dfb24abfc8bdb0fa324f",
            measurementId: "G-JW7E6Z7SR7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ===== LOGIN =====
        // SHA-256 of "admin123" this is default password and you need to change - Ahihi
        let PASSWORD_HASH = '5bb5b89bac8940a06515efe800d6fd10bda1557c1d4c6860d9c50e93166c4ee5';

        // Load password from Firebase if set
        db.ref('settings/passwordHash').on('value', snap => {
            if (snap.val()) PASSWORD_HASH = snap.val();
        });

        if (sessionStorage.getItem('meal_admin') === 'true') {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('top-bar').style.display = '';
            document.getElementById('app').style.display = '';
        }

        async function sha256(msg) {
            const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(msg));
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function checkLogin() {
            const pw = document.getElementById('pw-input').value;
            const hash = await sha256(pw);
            if (hash === PASSWORD_HASH) {
                sessionStorage.setItem('meal_admin', 'true');
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('top-bar').style.display = '';
                document.getElementById('app').style.display = '';
            } else {
                document.getElementById('login-err').style.display = 'block';
            }
        }

        async function changePassword() {
            const pw = document.getElementById('new-password').value;
            const pw2 = document.getElementById('confirm-password').value;
            if (!pw || pw.length < 4) { alert('M·∫≠t kh·∫©u t·ªëi thi·ªÉu 4 k√Ω t·ª±'); return; }
            if (pw !== pw2) { alert('M·∫≠t kh·∫©u kh√¥ng kh·ªõp!'); return; }
            const hash = await sha256(pw);
            await db.ref('settings/passwordHash').set(hash);
            PASSWORD_HASH = hash;
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            toast('‚úÖ ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u!');
        }

        // ===== STATE =====
        let employees = {};
        let viewDateMenu = [];   // menu for currently viewed date
        let viewDateOrders = {};  // orders for currently viewed date
        let allOrders = {};
        let settings = { deadline: '10:00' };
        let editingStaffId = null;
        let pickupEmpId = null;
        let viewDate = getToday();  // currently viewed date in orders panel
        let viewDateListener = null; // Firebase listener for viewed date orders
        let viewMenuListener = null; // Firebase listener for viewed date menu
        let menuDate = getToday();   // currently selected date in menu panel
        let menuDateListener = null; // Firebase listener for menu panel date

        function getToday() {
            const d = new Date();
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }

        function getDisplayDate() {
            const d = new Date();
            const days = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            return days[d.getDay()] + ', ' + d.getDate() + '/' + (d.getMonth() + 1) + '/' + d.getFullYear();
        }

        function formatDateVN(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            const days = ['Ch·ªß nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
            return days[d.getDay()] + ', ' + d.getDate() + '/' + (d.getMonth() + 1) + '/' + d.getFullYear();
        }

        // ===== FIREBASE LISTENERS =====
        db.ref('settings').on('value', snap => {
            const d = snap.val();
            if (d) {
                if (d.deadline) settings.deadline = d.deadline;
            }
            document.getElementById('set-deadline').value = settings.deadline;
        });

        db.ref('employees').on('value', snap => {
            employees = snap.val() || {};
            renderStaff();
        });

        // Menu panel listener (dynamic date)
        function listenMenuDate(date) {
            if (menuDateListener) menuDateListener();
            const menuRef = db.ref('menus/' + date);
            const callback = menuRef.on('value', snap => {
                const d = snap.val();
                renderMenuAdmin(d);
                // If viewing same date in orders panel, also refresh
                if (viewDate === date) {
                    viewDateMenu = d ? Object.entries(d).map(([id, v]) => ({ id, name: typeof v === 'string' ? v : v.name })) : [];
                }
            });
            menuDateListener = () => menuRef.off('value', callback);
        }

        // Load all orders for stats
        db.ref('orders').on('value', snap => {
            allOrders = snap.val() || {};
        });

        // Listen for viewDate orders + menu
        function listenViewDate(date) {
            // Remove old listeners
            if (viewDateListener) viewDateListener();
            if (viewMenuListener) viewMenuListener();

            const ordersRef = db.ref('orders/' + date);
            const menuRef = db.ref('menus/' + date);

            const ordersCallback = ordersRef.on('value', snap => {
                viewDateOrders = snap.val() || {};
                renderOrders();
            });

            const menuCallback = menuRef.on('value', snap => {
                const d = snap.val();
                viewDateMenu = d ? Object.entries(d).map(([id, v]) => ({ id, name: typeof v === 'string' ? v : v.name })) : [];
                renderOrders(); // re-render to update dish filter
            });

            viewDateListener = () => ordersRef.off('value', ordersCallback);
            viewMenuListener = () => menuRef.off('value', menuCallback);
        }

        // ===== VIEW DATE CONTROLS =====
        function changeViewDate() {
            viewDate = document.getElementById('view-date').value;
            document.getElementById('view-date-label').textContent = formatDateVN(viewDate);
            listenViewDate(viewDate);
        }

        function shiftViewDate(delta) {
            const d = new Date(viewDate + 'T00:00:00');
            d.setDate(d.getDate() + delta);
            viewDate = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            document.getElementById('view-date').value = viewDate;
            document.getElementById('view-date-label').textContent = formatDateVN(viewDate);
            listenViewDate(viewDate);
        }

        function goToday() {
            viewDate = getToday();
            document.getElementById('view-date').value = viewDate;
            document.getElementById('view-date-label').textContent = formatDateVN(viewDate) + ' (h√¥m nay)';
            listenViewDate(viewDate);
        }

        // ===== MENU DATE CONTROLS =====
        function changeMenuDate() {
            menuDate = document.getElementById('menu-date').value;
            updateMenuDateLabel();
            listenMenuDate(menuDate);
        }

        function shiftMenuDate(delta) {
            const d = new Date(menuDate + 'T00:00:00');
            d.setDate(d.getDate() + delta);
            menuDate = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            document.getElementById('menu-date').value = menuDate;
            updateMenuDateLabel();
            listenMenuDate(menuDate);
        }

        function goTodayMenu() {
            menuDate = getToday();
            document.getElementById('menu-date').value = menuDate;
            updateMenuDateLabel();
            listenMenuDate(menuDate);
        }

        function updateMenuDateLabel() {
            const label = formatDateVN(menuDate) + (menuDate === getToday() ? ' (h√¥m nay)' : '');
            document.getElementById('menu-date-label').textContent = label;
            document.getElementById('menu-card-date-label').textContent = label;
        }

        // ===== INIT =====
        document.getElementById('top-date').textContent = getDisplayDate();
        document.getElementById('view-date').value = getToday();
        document.getElementById('view-date-label').textContent = formatDateVN(getToday()) + ' (h√¥m nay)';
        listenViewDate(getToday());

        // Init menu date picker
        document.getElementById('menu-date').value = getToday();
        updateMenuDateLabel();
        listenMenuDate(getToday());

        // Default stats dates
        const today = new Date();
        const weekAgo = new Date(today); weekAgo.setDate(today.getDate() - 7);
        document.getElementById('stats-from').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('stats-to').value = getToday();

        // Pickup modal toggle
        document.getElementById('pickup-who').addEventListener('change', e => {
            document.getElementById('pickup-other-group').style.display = e.target.value === 'other' ? '' : 'none';
        });

        // ===== TABS =====
        function switchTab(t) {
            const tabs = ['orders', 'menu', 'staff', 'stats', 'settings'];
            document.querySelectorAll('.tab').forEach((el, i) => el.classList.toggle('active', tabs[i] === t));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-' + t).classList.add('active');
            if (t === 'stats') loadStats();
        }

        // ===== ORDERS =====
        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML }

        function renderOrders() {
            const tbody = document.getElementById('orders-tbody');
            const empty = document.getElementById('orders-empty');
            const entries = Object.entries(viewDateOrders);
            const isToday = viewDate === getToday();

            // Stats
            const total = entries.length;
            const picked = entries.filter(([, o]) => o.pickedUp).length;
            document.getElementById('s-total').textContent = total;
            document.getElementById('s-picked').textContent = picked;
            document.getElementById('s-waiting').textContent = total - picked;
            const dishes = new Set(entries.map(([, o]) => o.dish));
            document.getElementById('s-dishes').textContent = dishes.size;

            // Dish breakdown ‚Äî detailed with names
            const breakdown = {};
            entries.forEach(([empId, o]) => {
                const dn = o.dishName || 'Kh√¥ng r√µ';
                if (!breakdown[dn]) breakdown[dn] = { count: 0, people: [] };
                breakdown[dn].count++;
                breakdown[dn].people.push({
                    name: o.empName || o.empCode || '?',
                    code: o.empCode || '',
                    picked: !!o.pickedUp
                });
            });

            const breakdownHTML = Object.entries(breakdown).map(([name, data]) => {
                const peopleList = data.people.map(p =>
                    `<span style="display:inline-flex;align-items:center;gap:3px;padding:3px 8px;background:#fff;border-radius:6px;font-size:0.78rem;border:1px solid var(--border);margin:2px">
        ${p.picked ? '‚úÖ' : '‚è≥'} ${esc(p.name)}
      </span>`
                ).join('');

                return `<div style="padding:14px;background:var(--primary-light);border-radius:10px;margin-bottom:8px;border-left:4px solid var(--primary)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-weight:700;font-size:0.95rem">${esc(name)}</span>
        <span style="font-weight:800;color:var(--primary);font-size:1.1rem;background:#fff;padding:4px 12px;border-radius:20px;border:1px solid var(--border)">${data.count} ph·∫ßn</span>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:2px">${peopleList}</div>
    </div>`;
            }).join('');

            document.getElementById('dish-breakdown').innerHTML = breakdownHTML ||
                '<p style="color:var(--dim);font-size:0.85rem;text-align:center;padding:12px">Ch∆∞a c√≥ ƒë∆°n ng√†y n√†y</p>';
            document.getElementById('breakdown-total-label').textContent = total > 0
                ? 'T·ªïng: ' + total + ' ph·∫ßn ‚Äî ' + Object.keys(breakdown).length + ' m√≥n'
                : '';

            // Dish filter dropdown
            const filterSelect = document.getElementById('filter-dish');
            const currentFilter = filterSelect.value;
            filterSelect.innerHTML = '<option value="">T·∫•t c·∫£ m√≥n (' + total + ')</option>' +
                Object.entries(breakdown).map(([name, data]) =>
                    `<option value="${esc(name)}" ${currentFilter === name ? 'selected' : ''}>${esc(name)} (${data.count})</option>`
                ).join('');

            // Filter entries
            let filtered = entries;
            if (currentFilter) {
                filtered = entries.filter(([, o]) => (o.dishName || '') === currentFilter);
            }

            if (!filtered.length) {
                tbody.innerHTML = '';
                empty.style.display = total > 0 && currentFilter ? 'none' : '';
                if (total > 0 && currentFilter && !filtered.length) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--dim);padding:20px">Kh√¥ng c√≥ ƒë∆°n cho b·ªô l·ªçc n√†y</td></tr>';
                }
                if (!total) empty.style.display = '';
                return;
            }
            empty.style.display = 'none';

            tbody.innerHTML = filtered.sort((a, b) => (a[1].time || 0) - (b[1].time || 0)).map(([empId, o], i) => {
                const time = o.time ? new Date(o.time).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '--';
                const statusBadge = o.pickedUp
                    ? `<span class="badge badge-picked">‚úÖ ƒê√£ l·∫•y</span>`
                    : `<span class="badge badge-waiting">‚è≥ Ch∆∞a l·∫•y</span>`;

                let actionCell;
                if (isToday) {
                    // Only allow pickup actions for today
                    actionCell = o.pickedUp
                        ? `<button class="pickup-btn picked" onclick="undoPickup('${empId}')">‚Ü©Ô∏è Ho√†n</button>`
                        : `<button class="pickup-btn not-picked" onclick="showPickupModal('${empId}')">üç± L·∫•y</button>`;
                } else {
                    actionCell = o.pickedUp
                        ? `<span style="font-size:0.75rem;color:var(--success)">‚úÖ</span>`
                        : `<span style="font-size:0.75rem;color:var(--dim)">‚Äî</span>`;
                }

                const pickedByInfo = o.pickedBy ? `<br><small style="color:var(--dim)">L·∫•y h·ªô: ${esc(o.pickedBy)}</small>` : '';

                return `<tr>
      <td>${i + 1}</td>
      <td><strong>${esc(o.empCode || '')}</strong></td>
      <td>${esc(o.empName || '')}</td>
      <td>${esc(o.dishName || '')}</td>
      <td>${time}</td>
      <td>${statusBadge}${pickedByInfo}</td>
      <td>${actionCell}</td>
    </tr>`;
            }).join('');
        }

        // Pickup
        function showPickupModal(empId) {
            pickupEmpId = empId;
            const o = viewDateOrders[empId];
            document.getElementById('pickup-info').textContent = (o.empName || '') + ' ‚Äî ' + (o.dishName || '');
            document.getElementById('pickup-who').value = 'self';
            document.getElementById('pickup-other-group').style.display = 'none';
            document.getElementById('pickup-other-name').value = '';
            document.getElementById('pickup-modal').classList.remove('hidden');
        }

        function closePickupModal() { document.getElementById('pickup-modal').classList.add('hidden'); }

        async function confirmPickup() {
            if (!pickupEmpId) return;
            const who = document.getElementById('pickup-who').value;
            const otherName = document.getElementById('pickup-other-name').value.trim();
            await db.ref('orders/' + viewDate + '/' + pickupEmpId).update({
                pickedUp: true,
                pickedBy: who === 'other' ? otherName : ''
            });
            closePickupModal();
            toast('‚úÖ ƒê√£ x√°c nh·∫≠n l·∫•y c∆°m');
        }

        async function undoPickup(empId) {
            await db.ref('orders/' + viewDate + '/' + empId).update({ pickedUp: false, pickedBy: '' });
        }

        // ===== MENU =====
        let todayMenuData = null; // raw menu data for today (admin editing)

        function renderMenuAdmin(data) {
            if (data !== undefined) todayMenuData = data;
            const menuList = todayMenuData ? Object.entries(todayMenuData).map(([id, v]) => ({ id, name: typeof v === 'string' ? v : v.name })) : [];

            const list = document.getElementById('menu-items-list');
            const empty = document.getElementById('menu-empty');
            if (!menuList.length) { list.innerHTML = ''; empty.style.display = ''; return; }
            empty.style.display = 'none';

            // Get orders for the selected menu date for count
            const dateOrd = allOrders[menuDate] || {};
            const orderCounts = {};
            Object.values(dateOrd).forEach(o => { orderCounts[o.dish] = (orderCounts[o.dish] || 0) + 1; });

            list.innerHTML = menuList.map((item, i) => `
    <div style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--primary-light);border-radius:10px;margin-bottom:8px">
      <span style="font-weight:800;color:var(--primary);min-width:24px">${i + 1}</span>
      <span style="flex:1;font-weight:600">${esc(item.name)}</span>
      <span style="font-size:0.8rem;color:var(--dim)">${orderCounts[item.id] || 0} ƒë·∫∑t</span>
      <button class="btn btn-danger btn-sm" onclick="removeDish('${item.id}')" style="padding:4px 10px;font-size:0.75rem">‚úï</button>
    </div>
  `).join('');
        }

        async function addDish() {
            const input = document.getElementById('new-dish');
            const name = input.value.trim();
            if (!name) return;
            const id = 'dish_' + Date.now().toString(36);
            await db.ref('menus/' + menuDate + '/' + id).set(name);
            input.value = ''; input.focus();
            toast('‚úÖ ƒê√£ th√™m: ' + name);
        }

        async function bulkAddDishes() {
            const text = document.getElementById('bulk-dishes').value.trim();
            if (!text) return;
            const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
            const updates = {};
            lines.forEach(name => { updates['dish_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 5)] = name; });
            await db.ref('menus/' + menuDate).update(updates);
            document.getElementById('bulk-dishes').value = '';
            toast('‚úÖ ƒê√£ th√™m ' + lines.length + ' m√≥n');
        }

        async function removeDish(id) {
            if (!confirm('Xo√° m√≥n n√†y?')) return;
            await db.ref('menus/' + menuDate + '/' + id).remove();
        }

        async function copyMenuFrom() {
            const date = document.getElementById('copy-date').value;
            if (!date) { alert('Ch·ªçn ng√†y c·∫ßn copy!'); return; }
            const snap = await db.ref('menus/' + date).once('value');
            const data = snap.val();
            if (!data) { alert('Ng√†y ' + date + ' kh√¥ng c√≥ menu!'); return; }
            // Create new IDs
            const updates = {};
            Object.values(data).forEach(name => {
                updates['dish_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 5)] = typeof name === 'string' ? name : name.name;
            });
            await db.ref('menus/' + menuDate).update(updates);
            toast('‚úÖ ƒê√£ copy menu t·ª´ ' + date + ' sang ' + menuDate);
        }

        // ===== STAFF =====
        function renderStaff() {
            const tbody = document.getElementById('staff-tbody');
            const empty = document.getElementById('staff-empty');
            const search = (document.getElementById('staff-search')?.value || '').toLowerCase();

            let entries = Object.entries(employees);
            if (search) {
                entries = entries.filter(([, e]) =>
                    (e.code || '').toLowerCase().includes(search) || (e.name || '').toLowerCase().includes(search)
                );
            }

            if (!entries.length) { tbody.innerHTML = ''; empty.style.display = ''; return; }
            empty.style.display = 'none';

            tbody.innerHTML = entries.sort((a, b) => (a[1].code || '').localeCompare(b[1].code || '')).map(([id, e], i) => `
    <tr>
      <td>${i + 1}</td>
      <td><strong>${esc(e.code || '')}</strong></td>
      <td>${esc(e.name || '')}</td>
      <td><span class="badge ${e.active ? 'badge-active' : 'badge-inactive'}">${e.active ? 'ƒêang l√†m' : 'ƒê√£ ngh·ªâ'}</span></td>
      <td>
        <button class="btn btn-outline btn-sm" onclick="editStaff('${id}')">‚úèÔ∏è</button>
      </td>
    </tr>
  `).join('');
        }

        function showAddStaffModal() {
            editingStaffId = null;
            document.getElementById('modal-title').textContent = '‚ûï Th√™m nh√¢n vi√™n';
            document.getElementById('m-code').value = '';
            document.getElementById('m-name').value = '';
            document.getElementById('m-active').value = 'true';
            document.getElementById('m-code').disabled = false;
            document.getElementById('staff-modal').classList.remove('hidden');
        }

        function editStaff(id) {
            editingStaffId = id;
            const e = employees[id];
            document.getElementById('modal-title').textContent = '‚úèÔ∏è S·ª≠a nh√¢n vi√™n';
            document.getElementById('m-code').value = e.code || '';
            document.getElementById('m-name').value = e.name || '';
            document.getElementById('m-active').value = String(e.active);
            document.getElementById('m-code').disabled = true;
            document.getElementById('staff-modal').classList.remove('hidden');
        }

        function closeStaffModal() { document.getElementById('staff-modal').classList.add('hidden'); }

        async function saveStaff() {
            const code = document.getElementById('m-code').value.trim();
            const name = document.getElementById('m-name').value.trim();
            const active = document.getElementById('m-active').value === 'true';
            if (!code || !name) { alert('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!'); return; }

            if (editingStaffId) {
                await db.ref('employees/' + editingStaffId).update({ name, active });
            } else {
                // Check duplicate code
                const exists = Object.values(employees).find(e => (e.code || '').toUpperCase() === code.toUpperCase());
                if (exists) { alert('M√£ "' + code + '" ƒë√£ t·ªìn t·∫°i!'); return; }
                const id = 'emp_' + Date.now().toString(36);
                await db.ref('employees/' + id).set({ code: code.toUpperCase(), name, active: true });
            }
            closeStaffModal();
            toast('‚úÖ ƒê√£ l∆∞u nh√¢n vi√™n');
        }

        async function bulkAddStaff() {
            const text = document.getElementById('bulk-staff').value.trim();
            if (!text) return;
            const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
            let count = 0;
            for (const line of lines) {
                const parts = line.split(',').map(s => s.trim());
                if (parts.length < 2) continue;
                const [code, name] = parts;
                const exists = Object.values(employees).find(e => (e.code || '').toUpperCase() === code.toUpperCase());
                if (exists) continue;
                const id = 'emp_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 5);
                await db.ref('employees/' + id).set({ code: code.toUpperCase(), name, active: true });
                count++;
            }
            document.getElementById('bulk-staff').value = '';
            toast('‚úÖ ƒê√£ th√™m ' + count + ' nh√¢n vi√™n');
        }

        // ===== STATS =====
        function loadStats() {
            const mode = document.getElementById('stats-mode').value;
            const from = document.getElementById('stats-from').value;
            const to = document.getElementById('stats-to').value;
            if (!from || !to) return;

            // Collect dates in range
            const dates = [];
            const d = new Date(from);
            const end = new Date(to);
            while (d <= end) {
                dates.push(d.toISOString().split('T')[0]);
                d.setDate(d.getDate() + 1);
            }

            // Gather data
            let totalOrders = 0, totalPicked = 0;
            const dailyData = [];

            dates.forEach(date => {
                const orders = allOrders[date] || {};
                const entries = Object.entries(orders);
                const count = entries.length;
                const picked = entries.filter(([, o]) => o.pickedUp).length;
                totalOrders += count;
                totalPicked += picked;
                dailyData.push({ date, count, picked, orders: entries });
            });

            // Summary
            document.getElementById('stats-summary').innerHTML = `
    <div class="stat-card"><div class="num">${dates.length}</div><div class="label">S·ªë ng√†y</div></div>
    <div class="stat-card"><div class="num">${totalOrders}</div><div class="label">T·ªïng ƒë·∫∑t</div></div>
    <div class="stat-card"><div class="num">${totalPicked}</div><div class="label">ƒê√£ l·∫•y</div></div>
    <div class="stat-card"><div class="num">${totalOrders ? Math.round(totalOrders / dates.length) : 0}</div><div class="label">TB/ng√†y</div></div>
  `;

            const thead = document.getElementById('stats-thead');
            const tbody = document.getElementById('stats-tbody');
            const empty = document.getElementById('stats-empty');

            if (mode === 'day') {
                thead.innerHTML = '<tr><th>Ng√†y</th><th>T·ªïng ƒë·∫∑t</th><th>ƒê√£ l·∫•y</th><th>Ch∆∞a l·∫•y</th></tr>';
                tbody.innerHTML = dailyData.map(d => `
      <tr><td>${d.date}</td><td><strong>${d.count}</strong></td>
      <td>${d.picked}</td><td>${d.count - d.picked}</td></tr>
    `).join('');
            } else if (mode === 'week') {
                // Group by week
                const weeks = {};
                dailyData.forEach(d => {
                    const dt = new Date(d.date);
                    const weekStart = new Date(dt); weekStart.setDate(dt.getDate() - dt.getDay() + 1);
                    const key = weekStart.toISOString().split('T')[0];
                    if (!weeks[key]) weeks[key] = { count: 0, picked: 0 };
                    weeks[key].count += d.count;
                    weeks[key].picked += d.picked;
                });
                thead.innerHTML = '<tr><th>Tu·∫ßn b·∫Øt ƒë·∫ßu</th><th>T·ªïng ƒë·∫∑t</th><th>ƒê√£ l·∫•y</th><th>Ch∆∞a l·∫•y</th></tr>';
                tbody.innerHTML = Object.entries(weeks).map(([w, d]) => `
      <tr><td>${w}</td><td><strong>${d.count}</strong></td>
      <td>${d.picked}</td><td>${d.count - d.picked}</td></tr>
    `).join('');
            } else {
                // Group by month
                const months = {};
                dailyData.forEach(d => {
                    const key = d.date.substring(0, 7);
                    if (!months[key]) months[key] = { count: 0, picked: 0 };
                    months[key].count += d.count;
                    months[key].picked += d.picked;
                });
                thead.innerHTML = '<tr><th>Th√°ng</th><th>T·ªïng ƒë·∫∑t</th><th>ƒê√£ l·∫•y</th><th>Ch∆∞a l·∫•y</th></tr>';
                tbody.innerHTML = Object.entries(months).map(([m, d]) => `
      <tr><td>${m}</td><td><strong>${d.count}</strong></td>
      <td>${d.picked}</td><td>${d.count - d.picked}</td></tr>
    `).join('');
            }

            empty.style.display = tbody.innerHTML ? 'none' : '';
        }

        // ===== SETTINGS =====
        async function saveSettings() {
            const deadline = document.getElementById('set-deadline').value;
            await db.ref('settings/deadline').set(deadline);
            toast('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t! Ch·ªët ƒë·∫∑t l√∫c ' + deadline);
        }

        async function clearTodayOrders() {
            const label = viewDate === getToday() ? 'h√¥m nay' : viewDate;
            if (!confirm('‚ö†Ô∏è XO√Å T·∫§T C·∫¢ ƒë∆°n ƒë·∫∑t c∆°m ng√†y ' + label + '? Kh√¥ng th·ªÉ ho√†n t√°c!')) return;
            await db.ref('orders/' + viewDate).remove();
            toast('üóëÔ∏è ƒê√£ xo√° t·∫•t c·∫£ ƒë∆°n ng√†y ' + label);
        }

        // ===== EXCEL EXPORT =====
        function exportDayExcel() {
            const entries = Object.entries(viewDateOrders);
            if (!entries.length) { alert('Ch∆∞a c√≥ ƒë∆°n ƒë·ªÉ xu·∫•t!'); return; }

            const data = entries.sort((a, b) => (a[1].time || 0) - (b[1].time || 0)).map(([empId, o], i) => ({
                'STT': i + 1,
                'M√£ NV': o.empCode || '',
                'H·ªç t√™n': o.empName || '',
                'M√≥n ƒÉn': o.dishName || '',
                'Gi·ªù ƒë·∫∑t': o.time ? new Date(o.time).toLocaleTimeString('vi-VN') : '',
                'ƒê√£ l·∫•y': o.pickedUp ? 'ƒê√£ l·∫•y' : 'Ch∆∞a l·∫•y',
                'L·∫•y h·ªô b·ªüi': o.pickedBy || ''
            }));

            // Add dish summary sheet
            const breakdown = {};
            entries.forEach(([, o]) => {
                const dn = o.dishName || 'Kh√¥ng r√µ';
                breakdown[dn] = (breakdown[dn] || 0) + 1;
            });
            const summaryData = Object.entries(breakdown).map(([name, count], i) => ({
                'STT': i + 1, 'M√≥n ƒÉn': name, 'S·ªë l∆∞·ª£ng': count
            }));
            summaryData.push({ 'STT': '', 'M√≥n ƒÉn': 'T·ªîNG C·ªòNG', 'S·ªë l∆∞·ª£ng': entries.length });

            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.json_to_sheet(summaryData);
            ws1['!cols'] = [{ wch: 5 }, { wch: 40 }, { wch: 12 }];
            XLSX.utils.book_append_sheet(wb, ws1, 'T·ªïng h·ª£p m√≥n');

            const ws2 = XLSX.utils.json_to_sheet(data);
            ws2['!cols'] = [{ wch: 5 }, { wch: 10 }, { wch: 22 }, { wch: 35 }, { wch: 10 }, { wch: 12 }, { wch: 18 }];
            XLSX.utils.book_append_sheet(wb, ws2, 'Chi ti·∫øt');

            XLSX.writeFile(wb, 'dat-com-' + viewDate + '.xlsx');
            toast('üì• ƒê√£ xu·∫•t Excel ng√†y ' + viewDate);
        }

        function exportStaffExcel() {
            const entries = Object.entries(employees);
            if (!entries.length) { alert('Ch∆∞a c√≥ nh√¢n vi√™n!'); return; }

            const data = entries.sort((a, b) => (a[1].code || '').localeCompare(b[1].code || '')).map(([id, e], i) => ({
                'STT': i + 1,
                'M√£ NV': e.code || '',
                'H·ªç t√™n': e.name || '',
                'Tr·∫°ng th√°i': e.active ? 'ƒêang l√†m' : 'ƒê√£ ngh·ªâ'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            ws['!cols'] = [{ wch: 5 }, { wch: 12 }, { wch: 25 }, { wch: 14 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Nh√¢n vi√™n');
            XLSX.writeFile(wb, 'nhan-vien.xlsx');
            toast('üì• ƒê√£ xu·∫•t danh s√°ch nh√¢n vi√™n!');
        }

        function exportStatsExcel() {
            const from = document.getElementById('stats-from').value;
            const to = document.getElementById('stats-to').value;
            if (!from || !to) { alert('Ch·ªçn kho·∫£ng th·ªùi gian!'); return; }

            const dates = [];
            const d = new Date(from);
            const end = new Date(to);
            while (d <= end) { dates.push(d.toISOString().split('T')[0]); d.setDate(d.getDate() + 1); }

            // Detail sheet - all orders
            const detailData = [];
            dates.forEach(date => {
                const orders = allOrders[date] || {};
                Object.entries(orders).forEach(([empId, o]) => {
                    detailData.push({
                        'Ng√†y': date,
                        'M√£ NV': o.empCode || '',
                        'H·ªç t√™n': o.empName || '',
                        'M√≥n ƒÉn': o.dishName || '',
                        'ƒê√£ l·∫•y': o.pickedUp ? 'ƒê√£ l·∫•y' : 'Ch∆∞a l·∫•y',
                        'L·∫•y h·ªô': o.pickedBy || ''
                    });
                });
            });

            // Summary sheet
            const summaryData = dates.map(date => {
                const orders = allOrders[date] || {};
                const entries = Object.entries(orders);
                return {
                    'Ng√†y': date,
                    'T·ªïng ƒë·∫∑t': entries.length,
                    'ƒê√£ l·∫•y': entries.filter(([, o]) => o.pickedUp).length,
                    'Ch∆∞a l·∫•y': entries.filter(([, o]) => !o.pickedUp).length
                };
            });

            const wb = XLSX.utils.book_new();

            const ws1 = XLSX.utils.json_to_sheet(summaryData);
            ws1['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 10 }];
            XLSX.utils.book_append_sheet(wb, ws1, 'T·ªïng h·ª£p');

            if (detailData.length) {
                const ws2 = XLSX.utils.json_to_sheet(detailData);
                ws2['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 22 }, { wch: 35 }, { wch: 10 }, { wch: 18 }];
                XLSX.utils.book_append_sheet(wb, ws2, 'Chi ti·∫øt');
            }

            XLSX.writeFile(wb, 'thong-ke-' + from + '-den-' + to + '.xlsx');
            toast('üì• ƒê√£ xu·∫•t Excel th·ªëng k√™!');
        }

        // ===== TOAST =====
        function toast(msg) {
            const old = document.querySelector('.toast');
            if (old) old.remove();
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>

</html>
